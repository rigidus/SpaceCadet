(quicklisp:quickload "alexandria")
(quicklisp:quickload "uiop")

(defparameter
    *raw*
  (read-from-string
   (concatenate
    'string
    "'"
    (uiop:read-file-string "SpaceCadet.kicad_pcb"))))

(print *raw*)

(defun find-nodes (tree)
  (cond
    ((null tree) nil)
    ((atom tree) nil)
    ((eq (car tree) 'FOOTPRINT)
     (let* ((footprint-name (cadr tree))
            (footprint-rest (cddr tree))
            (dep-property (find-dep-property footprint-rest)))
         (if dep-property
             (list (cons footprint-name dep-property))
             nil)))
    (t (mapcan #'find-nodes (cdr tree)))))

(defun find-dep-property (subtree)
  (cond
    ((null subtree) nil)
    ((atom subtree) nil)
    ((and (listp (car subtree))
          (eq (caar subtree) 'PROPERTY)
          (stringp (cadr (car subtree)))
          (string= (cadr (car subtree)) "dep"))
     (print (caddar subtree))
     ;; (print (car subtree))
     )
    (t (find-dep-property (cdr subtree)))))

;; Пример использования
(defparameter *raw2*
  '(KICAD_PCB (VERSION 20240108) (GENERATOR "pcbnew") (GENERATOR_VERSION "8.0")
    (GENERAL (THICKNESS 1.6) (LEGACY_TEARDROPS NO)) (PAPER "A2")
    (LAYERS
     (0 "F.Cu" SIGNAL)
     (31 "B.Cu" SIGNAL))
    (SETUP
     (STACKUP (LAYER "F.SilkS" (TYPE "Top Silk Screen"))
      (LAYER "F.Mask" (TYPE "Top Solder Mask") (THICKNESS 0.01))
      (LAYER "F.Cu" (TYPE "copper") (THICKNESS 0.035))
      (LAYER "dielectric 1" (TYPE "core") (THICKNESS 1.51) (MATERIAL "FR4")
       (EPSILON_R 4.5) (LOSS_TANGENT 0.02))
      (LAYER "B.Cu" (TYPE "copper") (THICKNESS 0.035))
      (LAYER "B.Mask" (TYPE "Bottom Solder Mask") (THICKNESS 0.01))
      (COPPER_FINISH "None")
      (DIELECTRIC_CONSTRAINTS NO))
     (PAD_TO_MASK_CLEARANCE 0) (ALLOW_SOLDERMASK_BRIDGES_IN_FOOTPRINTS NO)
     (GRID_ORIGIN 320.35 96.35))
    (NET 0 "") (NET 2 "GND") (NET 3 "COL4") (NET 4 "ROW0")
    (FOOTPRINT "Button_Switch_Keyboard:SW_MX_2U"
     (LAYER "F.Cu")
     (UUID "7aa37245-bf7d-4e47-ada1-02a427f4a700")
     (PROPERTY "Reference" "S_TERMINAL1" (AT 4.5 5.75 0) (LAYER "F.SilkS") (UUID "3878a3ad-87a6-40fb-a546-9e15cbd3129d"))
     (PROPERTY "dep" "S_MACRO1"
      (AT 0 0 0) (UNLOCKED YES) (LAYER "F.Fab") (HIDE YES) (UUID "56d09925-b698-45b4-90a8-64fd14cb5201")
      (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.15)))))
    (FOOTPRINT "Another_Footprint"
     (LAYER "F.Cu")
     (PROPERTY "Reference" "S_TERMINAL2" (AT 4.5 5.75 0) (LAYER "F.SilkS")
      (UUID "3878a3ad-87a6-40fb-a546-9e15cbd3129d"))
     (PROPERTY "dep" "S_MACRO2"
      (AT 0 0 0) (UNLOCKED YES) (LAYER "F.Fab") (HIDE YES)
      (UUID "56d09925-b698-45b4-90a8-64fd14cb5201")
      (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.15)))))
    (FOOTPRINT "Diode_SMD:D_SOD-123" (LAYER "F.Cu")
     (UUID "79f526b6-fe1d-4c59-add9-ef4f80c2ee06") (AT 399.058 487.366)
     (DESCR "SOD-123") (TAGS "SOD-123")
     (PROPERTY "Reference" "D_RIGHT_SPACE1" (AT 0 -2 0) (LAYER "F.SilkS")
      (UUID "14ac8a9c-a948-4992-b4e2-cca7a399b33e")
      (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.15))))
     (PROPERTY "Value" "D" (AT 0 2.1 0) (LAYER "F.Fab")
      (UUID "1543bc95-9299-4666-8de4-6d2498fd5fd0")
      (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.15))))
     (PROPERTY "Footprint" "Diode_SMD:D_SOD-123" (AT 0 0 0) (UNLOCKED YES)
      (LAYER "F.Fab") (HIDE YES) (UUID "20d1b7f7-85ff-4234-9c81-00e17a126080")
      (EFFECTS (FONT (SIZE 1.27 1.27))))
     (PROPERTY "Datasheet" "" (AT 0 0 0) (UNLOCKED YES) (LAYER "F.Fab")
      (HIDE YES) (UUID "d2f0920e-38af-4616-b9cd-a4c76bf466d5")
      (EFFECTS (FONT (SIZE 1.27 1.27))))
     (PROPERTY "Description" "Diode, small symbol" (AT 0 0 0) (UNLOCKED YES)
      (LAYER "F.Fab") (HIDE YES) (UUID "734ac16b-073b-4d9e-857b-9baef79c42f7")
      (EFFECTS (FONT (SIZE 1.27 1.27))))
     (MODEL "${KICAD8_3DMODEL_DIR}/Diode_SMD.3dshapes/D_SOD-123.wrl"
      (OFFSET (XYZ 0 0 0)) (SCALE (XYZ 1 1 1)) (ROTATE (XYZ 0 0 0))))))

(print
 (find-nodes *raw2*))


'(FOOTPRINT
  "Button_Switch_Keyboard:SW_MX_2U" (LAYER "F.Cu")
  (UUID "7aa37245-bf7d-4e47-ada1-02a427f4a700") (AT 124.86 138.865)
  (PROPERTY "Reference" "S_TERMINAL1" (AT 4.5 5.75 0) (LAYER "F.SilkS")
   (UUID "3878a3ad-87a6-40fb-a546-9e15cbd3129d")
   (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.12)) (JUSTIFY RIGHT TOP)))
  (PROPERTY "Value" "TERMINAL" (AT -4 -8.5 0) (LAYER "F.Fab")
   (UUID "47921b1a-9637-4540-acc5-0a6bb647aa87")
   (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.12)) (JUSTIFY LEFT TOP)))
  (PROPERTY "Footprint" "Button_Switch_Keyboard:SW_MX_2U" (AT 0 0 0)
   (UNLOCKED YES) (LAYER "F.Fab") (HIDE YES)
   (UUID "abfd02be-4c97-4c02-b661-05424d9ce30e")
   (EFFECTS (FONT (SIZE 1.27 1.27))))
  (PROPERTY "Datasheet" "" (AT 0 0 0) (UNLOCKED YES) (LAYER "F.Fab")
   (HIDE YES) (UUID "919765e3-f2fb-4cea-ab4b-7fe55059a631")
   (EFFECTS (FONT (SIZE 1.27 1.27))))
  (PROPERTY "Description" "" (AT 0 0 0) (UNLOCKED YES) (LAYER "F.Fab")
   (HIDE YES) (UUID "a4703e44-bc5d-41a4-9d8c-4fd6e2db02b7")
   (EFFECTS (FONT (SIZE 1.27 1.27))))
  (PROPERTY "dep" "S_MACRO1" (AT 0 0 0) (UNLOCKED YES) (LAYER "F.Fab")
   (HIDE YES) (UUID "56d09925-b698-45b4-90a8-64fd14cb5201")
   (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.15))))
  (PATH
   "/1a8342a5-15fc-454c-84eb-2b470c08f569/a6b31a68-7e85-4157-a45b-14db66896c1e")
  (SHEETNAME "Switch Matrix") (SHEETFILE "Switch Matrix.kicad_sch")
  (SOLDER_MASK_MARGIN 0.05) (CLEARANCE 0.1) (ATTR THROUGH_HOLE)
  (FP_LINE (START -7 -7.015) (END 7 -7.015) (STROKE (WIDTH 0.15) (TYPE SOLID))
   (LAYER "F.SilkS") (UUID "7b59858e-ed60-4eee-9516-99ae01f8ffaf"))
  (FP_LINE (START -7 6.985) (END -7 -7.015) (STROKE (WIDTH 0.15) (TYPE SOLID))
   (LAYER "F.SilkS") (UUID "f59107a7-3ef4-4482-989e-61816b1d02b3"))
  (FP_LINE (START 7 -7.015) (END 7 6.985) (STROKE (WIDTH 0.15) (TYPE SOLID))
   (LAYER "F.SilkS") (UUID "7f868310-8ae0-44a7-8796-9e2b836cc0c2"))
  (FP_LINE (START 7 6.985) (END -7 6.985) (STROKE (WIDTH 0.15) (TYPE SOLID))
   (LAYER "F.SilkS") (UUID "7520d588-ed11-43e6-a025-5a524109b503"))
  (FP_CIRCLE (CENTER -3.776 -2.59) (END -1.776 -2.59)
   (STROKE (WIDTH 0.12) (TYPE SOLID)) (FILL SOLID) (LAYER "B.Mask")
   (UUID "11dcc492-930c-4c36-baee-c98b33f65092"))
  (FP_CIRCLE (CENTER 2.56 -5.095) (END 4.56 -5.095)
   (STROKE (WIDTH 0.12) (TYPE SOLID)) (FILL SOLID) (LAYER "B.Mask")
   (UUID "78a41b26-a02f-4828-8891-b43c62882a8d"))
  (FP_RECT (START 19.05 -9.525) (END -19.05 9.525)
   (STROKE (WIDTH 0.12) (TYPE SOLID)) (FILL NONE) (LAYER "F.CrtYd")
   (UUID "098988ca-ca37-4928-a58c-9ac0bb8665af"))
  (FP_TEXT USER "${REFERENCE}" (AT -2.25 6.25 0) (UNLOCKED YES)
   (LAYER "B.SilkS") (UUID "7eb20972-36a7-477f-92ba-fef5f02acb0a")
   (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.15)) (JUSTIFY MIRROR)))
  (PAD "" NP_THRU_HOLE CIRCLE (AT -5.07 -0.015) (SIZE 1.7 1.7) (DRILL 1.7)
   (LAYERS "*.Cu" "*.Mask") (UUID "5e2af661-bde1-4296-8d1e-3d23c5467751"))
  (PAD "" NP_THRU_HOLE CIRCLE (AT 0.01 -0.015) (SIZE 4 4) (DRILL 4)
   (LAYERS "*.Cu" "*.Mask") (UUID "46f3916d-eef3-40e8-923f-1965bbc85bae"))
  (PAD "" NP_THRU_HOLE CIRCLE (AT 5.09 -0.015) (SIZE 1.7 1.7) (DRILL 1.7)
   (LAYERS "*.Cu" "*.Mask") (UUID "097763af-38d0-4b9f-9f18-2272f936f56e"))
  (PAD "1" THRU_HOLE CIRCLE (AT 2.55 -5.095) (SIZE 2.54 2.54) (DRILL 1.5)
   (LAYERS "*.Cu" "*.Mask") (REMOVE_UNUSED_LAYERS NO)
   (NET 478 "unconnected-(S_TERMINAL1-in-Pad1)") (PINFUNCTION "in")
   (PINTYPE "passive") (UUID "3f7d87ec-a5e1-4ce7-9be8-d1a62b2eb1be"))
  (PAD "2" THRU_HOLE CIRCLE (AT -3.8 -2.555) (SIZE 2.54 2.54) (DRILL 1.5)
   (LAYERS "*.Cu" "*.Mask") (REMOVE_UNUSED_LAYERS NO)
   (NET 479 "unconnected-(S_TERMINAL1-out-Pad2)") (PINFUNCTION "out")
   (PINTYPE "passive") (UUID "8182c948-b078-46c0-bc42-55f5b9804793"))
  (MODEL "${DXMON_3DMOD}/cherry-mx-switch/switch.step"
   (OFFSET (XYZ 0 -1.035 4.75)) (SCALE (XYZ 1 1 1)) (ROTATE (XYZ -90 0 0))))


(defun replace-in-tree (tree footprint-name new-coord-x new-coord-y)
  (cond
    ((null tree) nil)
    ((atom tree) tree)
    ((and (listp (car tree))
          (eq (caar tree) 'FOOTPRINT)
          (stringp (cadar tree))
          (string= (cadar tree) footprint-name))
     (let ((replaced (replace-coords (cddar tree) new-coord-x new-coord-y)))
       (cons 'FOOTPRINT (cons (cadar tree) replaced))))
    (t (cons (car tree)
             (replace-in-tree (cdr tree) footprint-name new-coord-x new-coord-y)))))

(defun replace-coords (footprint new-coord-x new-coord-y)
  (if (null footprint)
      nil
      (let ((curr (car footprint))
            (rest (cdr footprint)))
        (cond ((and (listp curr)
                    (eq (car curr) 'AT))
               (cons `(AT ,new-coord-x ,new-coord-y)
                     (replace-coords rest new-coord-x new-coord-y)))
              (t (cons curr
                       (replace-coords rest new-coord-x new-coord-y)))))))

;; Пример использования
(defparameter *raw2*
  '(KICAD_PCB (VERSION 20240108) (GENERATOR "pcbnew") (GENERATOR_VERSION "8.0")
    (GENERAL (THICKNESS 1.6) (LEGACY_TEARDROPS NO)) (PAPER "A2")
    (LAYERS
     (0 "F.Cu" SIGNAL)
     (31 "B.Cu" SIGNAL))
    (SETUP
     (STACKUP (LAYER "F.SilkS" (TYPE "Top Silk Screen"))
      (LAYER "F.Mask" (TYPE "Top Solder Mask") (THICKNESS 0.01))
      (LAYER "F.Cu" (TYPE "copper") (THICKNESS 0.035))
      (LAYER "dielectric 1" (TYPE "core") (THICKNESS 1.51) (MATERIAL "FR4")
       (EPSILON_R 4.5) (LOSS_TANGENT 0.02))
      (LAYER "B.Cu" (TYPE "copper") (THICKNESS 0.035))
      (LAYER "B.Mask" (TYPE "Bottom Solder Mask") (THICKNESS 0.01))
      (COPPER_FINISH "None")
      (DIELECTRIC_CONSTRAINTS NO))
     (PAD_TO_MASK_CLEARANCE 0) (ALLOW_SOLDERMASK_BRIDGES_IN_FOOTPRINTS NO)
     (GRID_ORIGIN 320.35 96.35))
    (NET 0 "") (NET 2 "GND") (NET 3 "COL4") (NET 4 "ROW0")
    (FOOTPRINT "Button_Switch_Keyboard:SW_MX_2U" (LAYER "F.Cu")
     (UUID "55e34a0d-9461-4b6c-81f3-9e9e980d1336") (AT 86.76 138.865)
     (PROPERTY "Reference" "S_MACRO1" (AT 4.5 5.75 0) (LAYER "F.SilkS")
      (UUID "bf9317e2-6679-4007-909a-be63b56f05f9")
      (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.12)) (JUSTIFY RIGHT TOP)))
     (PROPERTY "Value" "MACRO" (AT -4 -8.5 0) (LAYER "F.Fab")
      (UUID "3dfac21f-b4a5-4572-bdf3-d207c2ee7217")
      (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.12)) (JUSTIFY LEFT TOP)))
     (PROPERTY "Footprint" "Button_Switch_Keyboard:SW_MX_2U" (AT 0 0 0)
      (UNLOCKED YES) (LAYER "F.Fab") (HIDE YES)
      (UUID "b6cdf313-2ce0-48ec-89b2-1db56d8372cf")
      (EFFECTS (FONT (SIZE 1.27 1.27))))
     (PROPERTY "Datasheet" "" (AT 0 0 0) (UNLOCKED YES) (LAYER "F.Fab")
      (HIDE YES) (UUID "785bc7bc-3c73-46ee-92e1-5d5d9d1d0ad3")
      (EFFECTS (FONT (SIZE 1.27 1.27))))
     (PROPERTY "Description" "" (AT 0 0 0) (UNLOCKED YES) (LAYER "F.Fab")
      (HIDE YES) (UUID "10221169-4d18-4429-93ac-5e1263dd3174")
      (EFFECTS (FONT (SIZE 1.27 1.27))))
     (PATH
      "/1a8342a5-15fc-454c-84eb-2b470c08f569/6f163d38-e927-4bb8-81cf-024313ac950d")
     (SHEETNAME "Switch Matrix") (SHEETFILE "Switch Matrix.kicad_sch")
     (SOLDER_MASK_MARGIN 0.05) (CLEARANCE 0.1) (ATTR THROUGH_HOLE)
     (FP_LINE (START -7 -7.015) (END 7 -7.015) (STROKE (WIDTH 0.15) (TYPE SOLID))
      (LAYER "F.SilkS") (UUID "99fe8336-96cb-4d1f-8b28-3e27aefe7054"))
     (FP_LINE (START -7 6.985) (END -7 -7.015) (STROKE (WIDTH 0.15) (TYPE SOLID))
      (LAYER "F.SilkS") (UUID "59757c03-976c-4c2e-b9ff-22915c4ff0af"))
     (FP_LINE (START 7 -7.015) (END 7 6.985) (STROKE (WIDTH 0.15) (TYPE SOLID))
      (LAYER "F.SilkS") (UUID "3ef14f76-1b90-4a6c-90cd-0514263d0ab8"))
     (FP_LINE (START 7 6.985) (END -7 6.985) (STROKE (WIDTH 0.15) (TYPE SOLID))
      (LAYER "F.SilkS") (UUID "a6327d2d-ed36-46b3-a020-4d685d5ab504"))
     (FP_CIRCLE (CENTER -3.776 -2.59) (END -1.776 -2.59)
      (STROKE (WIDTH 0.12) (TYPE SOLID)) (FILL SOLID) (LAYER "B.Mask")
      (UUID "e285d4f2-7c19-486a-ac21-a64e0df5f446"))
     (FP_CIRCLE (CENTER 2.56 -5.095) (END 4.56 -5.095)
      (STROKE (WIDTH 0.12) (TYPE SOLID)) (FILL SOLID) (LAYER "B.Mask")
      (UUID "87ab5092-13fe-4cf8-9e8e-08c7e0861eb1"))
     (FP_RECT (START 19.05 -9.525) (END -19.05 9.525)
      (STROKE (WIDTH 0.12) (TYPE SOLID)) (FILL NONE) (LAYER "F.CrtYd")
      (UUID "f9ac93f8-b6f7-4691-991c-23dcd516b039"))
     (FP_TEXT USER "${REFERENCE}" (AT -2.25 6.25 0) (UNLOCKED YES)
      (LAYER "B.SilkS") (UUID "14399929-6269-4e10-b2c0-104e1847d157")
      (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.15)) (JUSTIFY MIRROR)))
     (PAD "" NP_THRU_HOLE CIRCLE (AT -5.07 -0.015) (SIZE 1.7 1.7) (DRILL 1.7)
      (LAYERS "*.Cu" "*.Mask") (UUID "8e3b0335-2b58-4f3b-9589-72a8d6394897"))
     (PAD "" NP_THRU_HOLE CIRCLE (AT 0.01 -0.015) (SIZE 4 4) (DRILL 4)
      (LAYERS "*.Cu" "*.Mask") (UUID "e6a1daf3-e82b-4a91-91f1-dd0233a5bdd4"))
     (PAD "" NP_THRU_HOLE CIRCLE (AT 5.09 -0.015) (SIZE 1.7 1.7) (DRILL 1.7)
      (LAYERS "*.Cu" "*.Mask") (UUID "5b470d23-467e-4f59-b0a3-96c2ec9c8865"))
     (PAD "1" THRU_HOLE CIRCLE (AT 2.55 -5.095) (SIZE 2.54 2.54) (DRILL 1.5)
      (LAYERS "*.Cu" "*.Mask") (REMOVE_UNUSED_LAYERS NO)
      (NET 393 "unconnected-(S_MACRO1-in-Pad1)") (PINFUNCTION "in")
      (PINTYPE "passive") (UUID "e0b6820b-11e8-4ec6-9f13-f9b7b30586c1"))
     (PAD "2" THRU_HOLE CIRCLE (AT -3.8 -2.555) (SIZE 2.54 2.54) (DRILL 1.5)
      (LAYERS "*.Cu" "*.Mask") (REMOVE_UNUSED_LAYERS NO)
      (NET 392 "unconnected-(S_MACRO1-out-Pad2)") (PINFUNCTION "out")
      (PINTYPE "passive") (UUID "065167b3-5857-4ecd-8b6c-f3014abc02ef"))
     (MODEL "${DXMON_3DMOD}/cherry-mx-switch/switch.step"
      (OFFSET (XYZ 0 -1.035 4.75)) (SCALE (XYZ 1 1 1)) (ROTATE (XYZ -90 0 0))))
    (FOOTPRINT "Another_Footprint"
     (LAYER "F.Cu")
     (PROPERTY "Reference" "S_TERMINAL2" (AT 4.5 5.75 0) (LAYER "F.SilkS")
      (UUID "3878a3ad-87a6-40fb-a546-9e15cbd3129d"))
     (PROPERTY "dep" "S_MACRO2"
      (AT 0 0 0) (UNLOCKED YES) (LAYER "F.Fab") (HIDE YES)
      (UUID "56d09925-b698-45b4-90a8-64fd14cb5201")
      (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.15)))))
    (FOOTPRINT "Diode_SMD:D_SOD-123" (LAYER "F.Cu")
     (UUID "79f526b6-fe1d-4c59-add9-ef4f80c2ee06") (AT 399.058 487.366)
     (DESCR "SOD-123") (TAGS "SOD-123")
     (PROPERTY "Reference" "D_RIGHT_SPACE1" (AT 0 -2 0) (LAYER "F.SilkS")
      (UUID "14ac8a9c-a948-4992-b4e2-cca7a399b33e")
      (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.15))))
     (PROPERTY "Value" "D" (AT 0 2.1 0) (LAYER "F.Fab")
      (UUID "1543bc95-9299-4666-8de4-6d2498fd5fd0")
      (EFFECTS (FONT (SIZE 1 1) (THICKNESS 0.15))))
     (PROPERTY "Footprint" "Diode_SMD:D_SOD-123" (AT 0 0 0) (UNLOCKED YES)
      (LAYER "F.Fab") (HIDE YES) (UUID "20d1b7f7-85ff-4234-9c81-00e17a126080")
      (EFFECTS (FONT (SIZE 1.27 1.27))))
     (PROPERTY "Datasheet" "" (AT 0 0 0) (UNLOCKED YES) (LAYER "F.Fab")
      (HIDE YES) (UUID "d2f0920e-38af-4616-b9cd-a4c76bf466d5")
      (EFFECTS (FONT (SIZE 1.27 1.27))))
     (PROPERTY "Description" "Diode, small symbol" (AT 0 0 0) (UNLOCKED YES)
      (LAYER "F.Fab") (HIDE YES) (UUID "734ac16b-073b-4d9e-857b-9baef79c42f7")
      (EFFECTS (FONT (SIZE 1.27 1.27))))
     (MODEL "${KICAD8_3DMODEL_DIR}/Diode_SMD.3dshapes/D_SOD-123.wrl"
      (OFFSET (XYZ 0 0 0)) (SCALE (XYZ 1 1 1)) (ROTATE (XYZ 0 0 0))))))

(print
 (replace-in-tree *raw2* "Button_Switch_Keyboard:SW_MX_2U" 123456 789012)
 )
